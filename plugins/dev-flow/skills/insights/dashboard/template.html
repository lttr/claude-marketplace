<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Codebase Insights</title>
    <style>
      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --surface-hover: #1c2129;
        --border: #30363d;
        --text: #c9d1d9;
        --text-muted: #8b949e;
        --accent: #58a6ff;
        --green: #3fb950;
        --yellow: #d29922;
        --red: #f85149;
        --purple: #a371f7;
        --orange: #db6d28;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }
      h1 {
        font-size: 1.25rem;
        font-weight: 600;
      }
      .date-range {
        color: var(--text-muted);
        font-size: 0.875rem;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 4px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }
      .tab {
        padding: 12px 20px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.875rem;
        border-bottom: 2px solid transparent;
      }
      .tab:hover {
        color: var(--text);
      }
      .tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Report View (default) */
      .report-layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        gap: 20px;
      }
      .report-nav {
        background: var(--surface);
        border-radius: 8px;
        padding: 12px;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
        position: sticky;
        top: 20px;
      }
      .report-nav-item {
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        margin-bottom: 4px;
      }
      .report-nav-item:hover {
        background: var(--surface-hover);
      }
      .report-nav-item.active {
        background: var(--accent);
        color: var(--bg);
      }
      .report-nav-type {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
      }
      .report-nav-item.active .report-nav-type {
        color: var(--bg);
        opacity: 0.7;
      }

      .report-body {
        background: var(--surface);
        border-radius: 8px;
        padding: 24px 32px;
        min-height: 400px;
      }
      .report-body h1,
      .report-body h2,
      .report-body h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
      }
      .report-body h1:first-child,
      .report-body h2:first-child {
        margin-top: 0;
      }
      .report-body ul,
      .report-body ol {
        padding-left: 1.5em;
        margin: 0.5em 0;
      }
      .report-body li {
        margin: 0.25em 0;
      }
      .report-body a {
        color: var(--accent);
      }
      .report-body strong {
        color: var(--text);
      }
      .report-body code {
        background: var(--bg);
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
      }
      .report-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
      }
      .report-body th,
      .report-body td {
        padding: 8px 12px;
        border: 1px solid var(--border);
        text-align: left;
      }
      .report-body th {
        background: var(--bg);
      }

      /* Activity Feed */
      .activity-feed {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .activity-section {
        background: var(--surface);
        border-radius: 8px;
        overflow: hidden;
      }
      .activity-section-header {
        padding: 12px 16px;
        background: var(--bg);
        font-weight: 600;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .activity-section-count {
        background: var(--border);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: normal;
      }

      .activity-item {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 12px;
      }
      .activity-item:last-child {
        border-bottom: none;
      }
      .activity-item:hover {
        background: var(--surface-hover);
      }

      .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
      }
      .icon-pr {
        background: var(--green);
        color: var(--bg);
      }
      .icon-pr-active {
        background: var(--yellow);
        color: var(--bg);
      }
      .icon-pr-conflict {
        background: var(--red);
        color: white;
      }
      .icon-commit {
        background: var(--purple);
        color: white;
      }
      .icon-workitem {
        background: var(--accent);
        color: var(--bg);
      }

      .activity-content {
        flex: 1;
        min-width: 0;
      }
      .activity-title {
        font-weight: 500;
        margin-bottom: 2px;
        display: flex;
        gap: 8px;
        align-items: baseline;
      }
      .activity-title a {
        color: var(--text);
        text-decoration: none;
      }
      .activity-title a:hover {
        color: var(--accent);
      }
      .activity-meta {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .activity-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
      }
      .badge-merged {
        background: var(--green);
        color: var(--bg);
      }
      .badge-active {
        background: var(--yellow);
        color: var(--bg);
      }
      .badge-conflict {
        background: var(--red);
        color: white;
      }
      .badge-review {
        background: var(--purple);
        color: white;
      }

      /* By Area */
      .area-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
      }
      .area-card {
        background: var(--surface);
        border-radius: 8px;
        padding: 16px;
      }
      .area-header {
        font-weight: 600;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
      }
      .area-items {
        font-size: 0.875rem;
      }
      .area-item {
        padding: 6px 0;
        border-bottom: 1px solid var(--border);
      }
      .area-item:last-child {
        border-bottom: none;
      }
      .area-item a {
        color: var(--accent);
        text-decoration: none;
      }
      .area-item a:hover {
        text-decoration: underline;
      }

      /* People View */
      .people-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }
      .person-card {
        background: var(--surface);
        border-radius: 8px;
        padding: 16px;
      }
      .person-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .person-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--accent);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        color: var(--bg);
      }
      .person-name {
        font-weight: 600;
      }
      .person-stats {
        font-size: 0.8rem;
        color: var(--text-muted);
      }
      .person-items {
        font-size: 0.875rem;
      }
      .person-item {
        padding: 4px 0;
      }
      .person-item a {
        color: var(--text-muted);
        text-decoration: none;
      }
      .person-item a:hover {
        color: var(--accent);
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Codebase Insights</h1>
        <span class="date-range" id="date-range"></span>
      </header>

      <div class="tabs">
        <button class="tab active" data-tab="report">Today's Report</button>
        <button class="tab" data-tab="activity">Activity Feed</button>
        <button class="tab" data-tab="areas">By Area</button>
        <button class="tab" data-tab="people">People</button>
        <button class="tab" data-tab="history">History</button>
      </div>

      <div id="report" class="tab-content active">
        <div class="report-layout">
          <div class="report-nav" id="report-nav"></div>
          <div class="report-body" id="report-body">
            <div class="empty-state">
              No reports yet. Run /df:insights:daily
            </div>
          </div>
        </div>
      </div>

      <div id="activity" class="tab-content">
        <div class="activity-feed" id="activity-feed"></div>
      </div>

      <div id="areas" class="tab-content">
        <div class="area-grid" id="areas-grid"></div>
      </div>

      <div id="people" class="tab-content">
        <div class="people-grid" id="people-grid"></div>
      </div>

      <div id="history" class="tab-content">
        <div class="report-layout">
          <div class="report-nav" id="history-nav"></div>
          <div class="report-body" id="history-body">
            <div class="empty-state">Select a report</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHARTJS_PLACEHOLDER -->
    <!-- MARKED_PLACEHOLDER -->

    <script>
      const DATA = {{DATA}};
      const REPORTS = {{REPORTS}};

      // Helpers
      const escapeHtml = s => s ? s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
      const prUrl = (pr) => pr.url || `https://dev.azure.com/drmaxglobal/ecommerce-operations/_git/${pr.repository}/pullrequest/${pr.id}`;
      const ticketUrl = (id) => `https://dev.azure.com/drmaxglobal/platform-team/_workitems/edit/${id}/`;
      const extractTicket = (title) => {
        const match = title?.match(/\((\d{5,6})\)/);
        return match ? match[1] : null;
      };
      const getArea = (pr) => {
        const branch = pr.sourceBranch || '';
        const title = pr.title || '';
        const combined = (branch + ' ' + title).toLowerCase();
        if (combined.includes('checkout') || combined.includes('cart') || combined.includes('payment')) return 'Checkout';
        if (combined.includes('catalog') || combined.includes('product') || combined.includes('filter')) return 'Catalog';
        if (combined.includes('search')) return 'Search';
        if (combined.includes('account') || combined.includes('profile') || combined.includes('auth')) return 'My Account';
        if (combined.includes('cms') || combined.includes('content')) return 'CMS';
        if (combined.includes('ui') || combined.includes('component')) return 'UI Library';
        if (combined.includes('base') || combined.includes('core')) return 'Core';
        if (combined.includes('i18n') || combined.includes('translation')) return 'i18n';
        if (combined.includes('perf') || combined.includes('inp') || combined.includes('cache')) return 'Performance';
        return 'Other';
      };
      const getInitials = (name) => {
        if (!name) return '?';
        const parts = name.replace(/\(.*\)/, '').trim().split(/\s+/);
        return parts.length > 1 ? (parts[0][0] + parts[parts.length-1][0]).toUpperCase() : name.substring(0, 2).toUpperCase();
      };

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // Date range
      const allDates = [...(DATA.prs || []).map(p => p.updatedDate || p.createdDate), ...(DATA.commits || []).map(c => c.date)].filter(Boolean).sort();
      if (allDates.length) {
        document.getElementById('date-range').textContent = allDates.length > 1
          ? `${allDates[0]} ‚Üí ${allDates[allDates.length - 1]}`
          : allDates[0];
      }

      // Sort reports by date (newest first)
      const sortedReports = REPORTS.sort((a, b) => b.name.localeCompare(a.name));
      const latestReport = sortedReports[0];

      // Blockers (conflicts, stuck PRs) - computed for Activity Feed
      const blockers = (DATA.prs || []).filter(pr =>
        pr.mergeStatus === 'conflicts' ||
        (pr.status === 'active' && pr.reviewers?.every(r => r.vote === 0))
      );

      // Report nav & body
      const reportNav = document.getElementById('report-nav');
      const reportBody = document.getElementById('report-body');

      if (sortedReports.length) {
        sortedReports.slice(0, 7).forEach((report, i) => {
          const type = report.name.includes('-W') ? 'Weekly' : 'Daily';
          const dateStr = report.name.replace('.md', '').replace('-insights', '');
          const item = document.createElement('div');
          item.className = 'report-nav-item' + (i === 0 ? ' active' : '');
          item.innerHTML = `<div>${dateStr}</div><div class="report-nav-type">${type}</div>`;
          item.onclick = () => {
            document.querySelectorAll('#report-nav .report-nav-item').forEach(r => r.classList.remove('active'));
            item.classList.add('active');
            reportBody.innerHTML = marked.parse(report.content);
          };
          reportNav.appendChild(item);
        });
        reportBody.innerHTML = marked.parse(latestReport.content);
      }

      // History nav (all reports)
      const historyNav = document.getElementById('history-nav');
      const historyBody = document.getElementById('history-body');

      sortedReports.forEach((report, i) => {
        const type = report.name.includes('-W') ? 'Weekly' : 'Daily';
        const dateStr = report.name.replace('.md', '').replace('-insights', '');
        const item = document.createElement('div');
        item.className = 'report-nav-item';
        item.innerHTML = `<div>${dateStr}</div><div class="report-nav-type">${type}</div>`;
        item.onclick = () => {
          document.querySelectorAll('#history-nav .report-nav-item').forEach(r => r.classList.remove('active'));
          item.classList.add('active');
          historyBody.innerHTML = marked.parse(report.content);
        };
        historyNav.appendChild(item);
      });

      // Activity Feed
      const activityFeed = document.getElementById('activity-feed');
      const prs = (DATA.prs || []).sort((a, b) => (b.updatedDate || b.createdDate).localeCompare(a.updatedDate || a.createdDate));

      // Blockers section (conflicts, needs review)
      if (blockers.length) {
        activityFeed.innerHTML += `
          <div class="activity-section" style="border: 1px solid var(--yellow);">
            <div class="activity-section-header" style="background: rgba(210, 153, 34, 0.2);">
              <span>‚ö†Ô∏è Needs Attention</span>
              <span class="activity-section-count">${blockers.length}</span>
            </div>
            ${blockers.map(pr => {
              const ticket = extractTicket(pr.title);
              const hasConflict = pr.mergeStatus === 'conflicts';
              const reason = hasConflict ? 'Conflicts' : 'Needs review';
              return `<div class="activity-item">
                <div class="activity-icon ${hasConflict ? 'icon-pr-conflict' : 'icon-pr-active'}">${hasConflict ? '!' : '?'}</div>
                <div class="activity-content">
                  <div class="activity-title">
                    <a href="${prUrl(pr)}" target="_blank">PR#${pr.id}</a>
                    <span class="activity-badge ${hasConflict ? 'badge-conflict' : 'badge-active'}">${reason}</span>
                    <span>${escapeHtml(pr.title)}</span>
                  </div>
                  <div class="activity-meta">
                    ${escapeHtml(pr.author)}
                    ${ticket ? ` ¬∑ <a href="${ticketUrl(ticket)}" target="_blank">#${ticket}</a>` : ''}
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        `;
      }

      // Merged PRs
      const merged = prs.filter(pr => pr.status === 'completed');
      if (merged.length) {
        activityFeed.innerHTML += `
          <div class="activity-section">
            <div class="activity-section-header">
              <span>‚úÖ Merged</span>
              <span class="activity-section-count">${merged.length}</span>
            </div>
            ${merged.map(pr => {
              const ticket = extractTicket(pr.title);
              return `<div class="activity-item">
                <div class="activity-icon icon-pr">‚úì</div>
                <div class="activity-content">
                  <div class="activity-title">
                    <a href="${prUrl(pr)}" target="_blank">PR#${pr.id}</a>
                    <span>${escapeHtml(pr.title)}</span>
                  </div>
                  <div class="activity-meta">
                    ${escapeHtml(pr.author)} ¬∑ ${pr.closedDate || pr.updatedDate}
                    ${ticket ? ` ¬∑ <a href="${ticketUrl(ticket)}" target="_blank">#${ticket}</a>` : ''}
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        `;
      }

      // Active PRs
      const active = prs.filter(pr => pr.status === 'active');
      if (active.length) {
        activityFeed.innerHTML += `
          <div class="activity-section">
            <div class="activity-section-header">
              <span>üîÑ In Progress</span>
              <span class="activity-section-count">${active.length}</span>
            </div>
            ${active.map(pr => {
              const ticket = extractTicket(pr.title);
              const hasConflict = pr.mergeStatus === 'conflicts';
              const hasApprovals = pr.reviewers?.some(r => r.vote > 0);
              const iconClass = hasConflict ? 'icon-pr-conflict' : 'icon-pr-active';
              const badge = hasConflict ? '<span class="activity-badge badge-conflict">Conflicts</span>' :
                           hasApprovals ? '<span class="activity-badge badge-review">Approved</span>' : '';
              return `<div class="activity-item">
                <div class="activity-icon ${iconClass}">${hasConflict ? '!' : '‚ãØ'}</div>
                <div class="activity-content">
                  <div class="activity-title">
                    <a href="${prUrl(pr)}" target="_blank">PR#${pr.id}</a>
                    ${badge}
                    <span>${escapeHtml(pr.title)}</span>
                  </div>
                  <div class="activity-meta">
                    ${escapeHtml(pr.author)} ‚Üí ${pr.targetBranch}
                    ${ticket ? ` ¬∑ <a href="${ticketUrl(ticket)}" target="_blank">#${ticket}</a>` : ''}
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        `;
      }

      // By Area
      const areasGrid = document.getElementById('areas-grid');
      const prsByArea = {};
      prs.forEach(pr => {
        const area = getArea(pr);
        if (!prsByArea[area]) prsByArea[area] = [];
        prsByArea[area].push(pr);
      });

      Object.entries(prsByArea).sort((a, b) => b[1].length - a[1].length).forEach(([area, areaPrs]) => {
        areasGrid.innerHTML += `
          <div class="area-card">
            <div class="area-header">
              <span>${area}</span>
              <span style="color: var(--text-muted); font-weight: normal;">${areaPrs.length} PRs</span>
            </div>
            <div class="area-items">
              ${areaPrs.slice(0, 8).map(pr => {
                const ticket = extractTicket(pr.title);
                const status = pr.status === 'completed' ? '‚úì' : '‚ãØ';
                return `<div class="area-item">
                  ${status} <a href="${prUrl(pr)}" target="_blank">PR#${pr.id}</a>
                  ${ticket ? `<a href="${ticketUrl(ticket)}" target="_blank">#${ticket}</a>` : ''}
                  <span style="color: var(--text-muted);">¬∑ ${escapeHtml(pr.author.split(' ')[0])}</span>
                </div>`;
              }).join('')}
              ${areaPrs.length > 8 ? `<div style="color: var(--text-muted); padding-top: 8px;">+${areaPrs.length - 8} more</div>` : ''}
            </div>
          </div>
        `;
      });

      // People
      const peopleGrid = document.getElementById('people-grid');
      const prsByPerson = {};
      prs.forEach(pr => {
        const author = pr.author || 'Unknown';
        if (!prsByPerson[author]) prsByPerson[author] = { prs: [], commits: 0 };
        prsByPerson[author].prs.push(pr);
      });
      (DATA.commits || []).forEach(c => {
        const author = c.author || 'Unknown';
        if (!prsByPerson[author]) prsByPerson[author] = { prs: [], commits: 0 };
        prsByPerson[author].commits++;
      });

      Object.entries(prsByPerson)
        .sort((a, b) => (b[1].prs.length + b[1].commits) - (a[1].prs.length + a[1].commits))
        .slice(0, 12)
        .forEach(([name, data]) => {
          const merged = data.prs.filter(p => p.status === 'completed').length;
          const active = data.prs.filter(p => p.status === 'active').length;

          peopleGrid.innerHTML += `
            <div class="person-card">
              <div class="person-header">
                <div class="person-avatar">${getInitials(name)}</div>
                <div>
                  <div class="person-name">${escapeHtml(name.replace(/\s*\(.*\)/, ''))}</div>
                  <div class="person-stats">
                    ${merged ? `${merged} merged` : ''}
                    ${active ? `${merged ? ' ¬∑ ' : ''}${active} active` : ''}
                    ${data.commits ? `${(merged || active) ? ' ¬∑ ' : ''}${data.commits} commits` : ''}
                  </div>
                </div>
              </div>
              <div class="person-items">
                ${data.prs.slice(0, 4).map(pr => {
                  const status = pr.status === 'completed' ? '‚úì' : '‚ãØ';
                  return `<div class="person-item">${status} <a href="${prUrl(pr)}" target="_blank">PR#${pr.id}: ${escapeHtml(pr.title.substring(0, 40))}${pr.title.length > 40 ? '...' : ''}</a></div>`;
                }).join('')}
              </div>
            </div>
          `;
        });

      if (!prs.length && !sortedReports.length) {
        activityFeed.innerHTML = '<div class="empty-state">No activity data. Run /df:insights:daily first.</div>';
      }
    </script>
  </body>
</html>
