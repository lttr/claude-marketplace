<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dev-Flow Insights Dashboard</title>
    <style>
      :root {
        --bg: #0d1117;
        --surface: #161b22;
        --border: #30363d;
        --text: #c9d1d9;
        --text-muted: #8b949e;
        --accent: #58a6ff;
        --green: #3fb950;
        --yellow: #d29922;
        --red: #f85149;
        --purple: #a371f7;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
      }
      .stats-bar {
        display: flex;
        gap: 24px;
        padding: 16px;
        background: var(--surface);
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .stat {
        display: flex;
        flex-direction: column;
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--accent);
      }
      .stat-label {
        font-size: 0.875rem;
        color: var(--text-muted);
      }
      .tabs {
        display: flex;
        gap: 4px;
        border-bottom: 1px solid var(--border);
        margin-bottom: 20px;
      }
      .tab {
        padding: 12px 20px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 0.875rem;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }
      .tab:hover {
        color: var(--text);
      }
      .tab.active {
        color: var(--accent);
        border-bottom-color: var(--accent);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .chart-card {
        background: var(--surface);
        border-radius: 8px;
        padding: 16px;
      }
      .chart-card h3 {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 12px;
      }
      .chart-container {
        position: relative;
        height: 250px;
      }
      .reports-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 20px;
      }
      .reports-list {
        background: var(--surface);
        border-radius: 8px;
        padding: 12px;
        max-height: 600px;
        overflow-y: auto;
      }
      .report-item {
        padding: 10px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: background 0.2s;
      }
      .report-item:hover {
        background: var(--border);
      }
      .report-item.active {
        background: var(--accent);
        color: var(--bg);
      }
      .report-item-date {
        font-size: 0.75rem;
        color: var(--text-muted);
      }
      .report-item.active .report-item-date {
        color: var(--bg);
        opacity: 0.7;
      }
      .report-content {
        background: var(--surface);
        border-radius: 8px;
        padding: 24px;
        min-height: 400px;
      }
      .report-content h1,
      .report-content h2,
      .report-content h3 {
        margin-top: 1.5em;
        margin-bottom: 0.5em;
      }
      .report-content h1:first-child {
        margin-top: 0;
      }
      .report-content ul,
      .report-content ol {
        padding-left: 1.5em;
      }
      .report-content a {
        color: var(--accent);
      }
      .report-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
      }
      .report-content th,
      .report-content td {
        padding: 8px 12px;
        border: 1px solid var(--border);
        text-align: left;
      }
      .report-content th {
        background: var(--bg);
      }
      .raw-data-section {
        background: var(--surface);
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .raw-data-header {
        padding: 12px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid transparent;
      }
      .raw-data-header:hover {
        background: var(--border);
        border-radius: 8px;
      }
      .raw-data-section.open .raw-data-header {
        border-bottom-color: var(--border);
        border-radius: 8px 8px 0 0;
      }
      .raw-data-content {
        display: none;
        padding: 16px;
        max-height: 400px;
        overflow: auto;
      }
      .raw-data-section.open .raw-data-content {
        display: block;
      }
      pre {
        background: var(--bg);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.8rem;
      }
      code {
        font-family: "Fira Code", monospace;
      }
      .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
      }
      .data-table th,
      .data-table td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
      }
      .data-table th {
        color: var(--text-muted);
        font-weight: 500;
        position: sticky;
        top: 0;
        background: var(--surface);
      }
      .data-table a {
        color: var(--accent);
        text-decoration: none;
      }
      .data-table a:hover {
        text-decoration: underline;
      }
      .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
      }
      .status-completed {
        background: var(--green);
        color: var(--bg);
      }
      .status-active {
        background: var(--yellow);
        color: var(--bg);
      }
      .status-abandoned {
        background: var(--red);
        color: white;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-muted);
      }
      .chevron {
        transition: transform 0.2s;
      }
      .raw-data-section.open .chevron {
        transform: rotate(180deg);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Dev-Flow Insights</h1>
        <span id="date-range"></span>
      </header>

      <div class="stats-bar">
        <div class="stat">
          <span class="stat-value" id="stat-prs">0</span>
          <span class="stat-label">Pull Requests</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="stat-commits">0</span>
          <span class="stat-label">Commits</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="stat-workitems">0</span>
          <span class="stat-label">Work Items</span>
        </div>
        <div class="stat">
          <span class="stat-value" id="stat-reports">0</span>
          <span class="stat-label">Reports</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="charts">Charts</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="raw">Raw Data</button>
      </div>

      <div id="charts" class="tab-content active">
        <div class="charts-grid">
          <div class="chart-card">
            <h3>PR Activity Over Time</h3>
            <div class="chart-container"><canvas id="pr-chart"></canvas></div>
          </div>
          <div class="chart-card">
            <h3>Commits by Author</h3>
            <div class="chart-container">
              <canvas id="commits-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Work Item States</h3>
            <div class="chart-container">
              <canvas id="workitems-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Activity Timeline</h3>
            <div class="chart-container">
              <canvas id="timeline-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="reports" class="tab-content">
        <div class="reports-layout">
          <div class="reports-list" id="reports-list"></div>
          <div class="report-content" id="report-content">
            <div class="empty-state">Select a report to view</div>
          </div>
        </div>
      </div>

      <div id="raw" class="tab-content">
        <div id="raw-data-container"></div>
      </div>
    </div>

    <!-- CHARTJS_PLACEHOLDER -->
    <!-- MARKED_PLACEHOLDER -->

    <script>
      // Data injected by generator
      const DATA = {{DATA}};
      const REPORTS = {{REPORTS}};

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // Stats
      document.getElementById('stat-prs').textContent = DATA.prs?.length || 0;
      document.getElementById('stat-commits').textContent = DATA.commits?.length || 0;
      document.getElementById('stat-workitems').textContent = DATA.workitems?.length || 0;
      document.getElementById('stat-reports').textContent = REPORTS.length;

      // Date range
      if (DATA.prs?.length || DATA.commits?.length) {
        const dates = [
          ...(DATA.prs || []).map(p => p.createdDate),
          ...(DATA.commits || []).map(c => c.date)
        ].filter(Boolean).sort();
        if (dates.length) {
          document.getElementById('date-range').textContent = `${dates[0]} - ${dates[dates.length - 1]}`;
        }
      }

      // Charts
      const chartColors = {
        blue: 'rgba(88, 166, 255, 0.8)',
        green: 'rgba(63, 185, 80, 0.8)',
        yellow: 'rgba(210, 153, 34, 0.8)',
        red: 'rgba(248, 81, 73, 0.8)',
        purple: 'rgba(163, 113, 247, 0.8)',
      };

      // PR Chart - by status
      if (DATA.prs?.length) {
        const prsByStatus = DATA.prs.reduce((acc, pr) => {
          acc[pr.status] = (acc[pr.status] || 0) + 1;
          return acc;
        }, {});
        new Chart(document.getElementById('pr-chart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(prsByStatus),
            datasets: [{
              data: Object.values(prsByStatus),
              backgroundColor: [chartColors.green, chartColors.yellow, chartColors.red]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#c9d1d9' } } }
          }
        });
      }

      // Commits by author
      if (DATA.commits?.length) {
        const byAuthor = DATA.commits.reduce((acc, c) => {
          acc[c.author] = (acc[c.author] || 0) + 1;
          return acc;
        }, {});
        const sorted = Object.entries(byAuthor).sort((a, b) => b[1] - a[1]).slice(0, 10);
        new Chart(document.getElementById('commits-chart'), {
          type: 'bar',
          data: {
            labels: sorted.map(([name]) => name),
            datasets: [{
              label: 'Commits',
              data: sorted.map(([, count]) => count),
              backgroundColor: chartColors.blue
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
              y: { ticks: { color: '#c9d1d9' }, grid: { display: false } }
            }
          }
        });
      }

      // Work items by state
      if (DATA.workitems?.length) {
        const byState = DATA.workitems.reduce((acc, wi) => {
          acc[wi.state] = (acc[wi.state] || 0) + 1;
          return acc;
        }, {});
        new Chart(document.getElementById('workitems-chart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(byState),
            datasets: [{
              data: Object.values(byState),
              backgroundColor: [chartColors.blue, chartColors.green, chartColors.yellow, chartColors.purple, chartColors.red]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#c9d1d9' } } }
          }
        });
      }

      // Activity timeline
      const allDates = new Set([
        ...(DATA.prs || []).map(p => p.createdDate),
        ...(DATA.commits || []).map(c => c.date)
      ].filter(Boolean));
      if (allDates.size) {
        const sortedDates = [...allDates].sort();
        const prsByDate = (DATA.prs || []).reduce((acc, pr) => {
          acc[pr.createdDate] = (acc[pr.createdDate] || 0) + 1;
          return acc;
        }, {});
        const commitsByDate = (DATA.commits || []).reduce((acc, c) => {
          acc[c.date] = (acc[c.date] || 0) + 1;
          return acc;
        }, {});
        new Chart(document.getElementById('timeline-chart'), {
          type: 'line',
          data: {
            labels: sortedDates,
            datasets: [
              {
                label: 'PRs',
                data: sortedDates.map(d => prsByDate[d] || 0),
                borderColor: chartColors.blue,
                tension: 0.3
              },
              {
                label: 'Commits',
                data: sortedDates.map(d => commitsByDate[d] || 0),
                borderColor: chartColors.green,
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: '#c9d1d9' } } },
            scales: {
              x: { ticks: { color: '#8b949e', maxTicksLimit: 10 }, grid: { color: '#30363d' } },
              y: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }
            }
          }
        });
      }

      // Reports list
      const reportsList = document.getElementById('reports-list');
      const reportContent = document.getElementById('report-content');
      if (REPORTS.length) {
        REPORTS.sort((a, b) => b.name.localeCompare(a.name)).forEach((report, i) => {
          const item = document.createElement('div');
          item.className = 'report-item' + (i === 0 ? ' active' : '');
          const type = report.name.includes('-W') ? 'Weekly' : 'Daily';
          item.innerHTML = `<div>${report.name.replace('.md', '').replace('-insights', '')}</div><div class="report-item-date">${type}</div>`;
          item.addEventListener('click', () => {
            document.querySelectorAll('.report-item').forEach(r => r.classList.remove('active'));
            item.classList.add('active');
            reportContent.innerHTML = marked.parse(report.content);
          });
          reportsList.appendChild(item);
        });
        // Show first report
        if (REPORTS[0]) {
          reportContent.innerHTML = marked.parse(REPORTS.sort((a, b) => b.name.localeCompare(a.name))[0].content);
        }
      } else {
        reportsList.innerHTML = '<div class="empty-state">No reports found</div>';
      }

      // Raw data
      const rawContainer = document.getElementById('raw-data-container');
      const rawFiles = [
        { name: 'Pull Requests', key: 'prs', data: DATA.prs },
        { name: 'Commits', key: 'commits', data: DATA.commits },
        { name: 'Work Items', key: 'workitems', data: DATA.workitems },
        { name: 'Confluence', key: 'confluence', data: DATA.confluence }
      ];

      rawFiles.forEach(({ name, key, data }) => {
        if (!data?.length) return;
        const section = document.createElement('div');
        section.className = 'raw-data-section';
        section.innerHTML = `
          <div class="raw-data-header">
            <span>${name} (${data.length})</span>
            <span class="chevron">â–¼</span>
          </div>
          <div class="raw-data-content">
            ${renderDataTable(key, data)}
          </div>
        `;
        section.querySelector('.raw-data-header').addEventListener('click', () => {
          section.classList.toggle('open');
        });
        rawContainer.appendChild(section);
      });

      function renderDataTable(key, data) {
        if (key === 'prs') {
          return `<table class="data-table">
            <thead><tr><th>Title</th><th>Author</th><th>Status</th><th>Created</th><th>Repo</th></tr></thead>
            <tbody>${data.map(pr => `
              <tr>
                <td><a href="${pr.url}" target="_blank">${escapeHtml(pr.title)}</a></td>
                <td>${escapeHtml(pr.author)}</td>
                <td><span class="status-badge status-${pr.status}">${pr.status}</span></td>
                <td>${pr.createdDate}</td>
                <td>${escapeHtml(pr.repository)}</td>
              </tr>
            `).join('')}</tbody>
          </table>`;
        }
        if (key === 'commits') {
          return `<table class="data-table">
            <thead><tr><th>Message</th><th>Author</th><th>Date</th><th>Repo</th></tr></thead>
            <tbody>${data.map(c => `
              <tr>
                <td>${escapeHtml(c.message.split('\n')[0])}</td>
                <td>${escapeHtml(c.author)}</td>
                <td>${c.date}</td>
                <td>${escapeHtml(c.repo)}</td>
              </tr>
            `).join('')}</tbody>
          </table>`;
        }
        if (key === 'workitems') {
          return `<table class="data-table">
            <thead><tr><th>Title</th><th>Type</th><th>State</th><th>Assigned</th></tr></thead>
            <tbody>${data.map(wi => `
              <tr>
                <td><a href="${wi.url}" target="_blank">${escapeHtml(wi.title)}</a></td>
                <td>${escapeHtml(wi.type)}</td>
                <td>${escapeHtml(wi.state)}</td>
                <td>${escapeHtml(wi.assignedTo || '-')}</td>
              </tr>
            `).join('')}</tbody>
          </table>`;
        }
        if (key === 'confluence') {
          return `<table class="data-table">
            <thead><tr><th>Title</th><th>Space</th><th>Modified</th><th>By</th></tr></thead>
            <tbody>${data.map(page => `
              <tr>
                <td><a href="${page.url}" target="_blank">${escapeHtml(page.title)}</a></td>
                <td>${escapeHtml(page.space)}</td>
                <td>${page.lastModified}</td>
                <td>${escapeHtml(page.lastModifiedBy)}</td>
              </tr>
            `).join('')}</tbody>
          </table>`;
        }
        return `<pre><code>${escapeHtml(JSON.stringify(data, null, 2))}</code></pre>`;
      }

      function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
      }
    </script>
  </body>
</html>
